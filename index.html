import React, { useState, useMemo, useEffect } from 'react';
import { 
  Users, Activity, Clock, CheckCircle, AlertCircle, MapPin, FileText, Menu, X, 
  PieChart, BarChart2, Calendar, Filter, AlertTriangle, Handshake, Trophy, TrendingUp, 
  Cake, Phone, Printer, Search, ArrowLeft, History, MessageCircle, CreditCard, Home, 
  UserCheck, XCircle, DollarSign, HeartPulse, Loader2, LogIn, Lock, Plus, Save, Edit
} from 'lucide-react';
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
  PieChart as RePieChart, Pie, Cell
} from 'recharts';

// --- CONFIGURAÇÃO DA API ---
const API_URL = "https://script.google.com/macros/s/AKfycbxNtohug1LnuzYn56ySQ97SvcmNbpxLeZgYYAeKwy_9tyWrH_l3SZKdcJElYQ2eVbEn3w/exec";

// --- PALETA DE CORES (GLOBAL) ---
const COLORS = {
  primary: '#0ea5e9',
  secondary: '#6366f1',
  success: '#22c55e',
  warning: '#eab308',
  danger: '#ef4444',
  gray: '#64748b',
  purple: '#a855f7',
  pie: ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d']
};

// --- TABELA DE PREÇOS ESTIMADOS ---
const PROCEDURE_VALUES = {
  'CATARATA': 4000, 'HÉRNIA': 3000, 'HERNIA': 3000, 'VESICULA': 3500, 'VESÍCULA': 3500,
  'HISTECTOMIA': 4500, 'PTERIGIO': 1500, 'PTERÍGIO': 1500, 'CONSULTA': 250, 'EXAME': 150,
  'RESSONANCIA': 800, 'TOMOGRAFIA': 600, 'ULTRASSOM': 200, 'BIOMETRIA': 300, 'DEFAULT': 100 
};

const getProcedureValue = (procName) => {
  if (!procName) return 0;
  const name = String(procName).toUpperCase();
  for (const key in PROCEDURE_VALUES) {
    if (name.includes(key)) return PROCEDURE_VALUES[key];
  }
  return PROCEDURE_VALUES['DEFAULT'];
};

// --- HELPERS DE DATA ---
const parseDate = (value) => {
  if (!value) return null;
  const date = new Date(value);
  if (!isNaN(date.getTime())) return date;
  
  if (typeof value === 'number') {
    return new Date(Math.round((value - 25569) * 86400 * 1000));
  }
  return null;
};

const formatDate = (dateValue) => {
  const date = parseDate(dateValue);
  return date ? date.toLocaleDateString('pt-BR') : '-';
};

const getMonthName = (dateValue) => {
  const date = parseDate(dateValue);
  if (!date) return 'Desconhecido';
  const month = date.toLocaleString('pt-BR', { month: 'long' });
  return month.charAt(0).toUpperCase() + month.slice(1);
};

const getYear = (dateValue) => {
  const date = parseDate(dateValue);
  return date ? date.getFullYear().toString() : 'Desconhecido';
};

const monthOrder = {
  'Janeiro': 1, 'Fevereiro': 2, 'Março': 3, 'Abril': 4, 'Maio': 5, 'Junho': 6,
  'Julho': 7, 'Agosto': 8, 'Setembro': 9, 'Outubro': 10, 'Novembro': 11, 'Dezembro': 12
};

const checkSurgicalRisk = (dataRisco, localAtendimento) => {
  if (!dataRisco) return { status: 'none', msg: 'Sem data' };
  const dtRisco = parseDate(dataRisco);
  if (!dtRisco) return { status: 'none', msg: 'Data inválida' };

  const local = localAtendimento ? String(localAtendimento).toUpperCase() : '';
  const isHO = local.includes('HO') || local.includes('OLHO');
  const validadeMeses = isHO ? 6 : 3;
  
  const dtVencimento = new Date(dtRisco);
  dtVencimento.setMonth(dtVencimento.getMonth() + validadeMeses);
  
  const hoje = new Date();
  const diffTime = dtVencimento - hoje;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

  if (diffDays < 0) return { status: 'expired', msg: `Venceu: ${dtVencimento.toLocaleDateString('pt-BR')}`, color: 'text-red-600 bg-red-50 border-red-200' };
  if (diffDays <= 30) return { status: 'warning', msg: `Vence em ${diffDays} dias`, color: 'text-orange-600 bg-orange-50 border-orange-200' };
  return { status: 'ok', msg: `Válido até ${dtVencimento.toLocaleDateString('pt-BR')}`, color: 'text-green-600 bg-green-50 border-green-200' };
};

// --- COMPONENTE PRINCIPAL ---
export default function App() {
  const [userMode, setUserMode] = useState(null); 
  const [loginPass, setLoginPass] = useState('');
  const [loginError, setLoginError] = useState('');

  const [joinedData, setJoinedData] = useState([]); 
  const [rawData, setRawData] = useState({ pacientes: [], atendimentos: [] });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [activeTab, setActiveTab] = useState('Dashboard');
  const [selectedMonth, setSelectedMonth] = useState('Geral');
  const [selectedYear, setSelectedYear] = useState('Geral');
  
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedPatient, setSelectedPatient] = useState(null);

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [modalType, setModalType] = useState(null); 
  const [formData, setFormData] = useState({});
  const [saving, setSaving] = useState(false);

  // --- BUSCA DADOS ---
  const fetchData = async () => {
    setLoading(true);
    setError(null);
    try {
      const response = await fetch(API_URL);
      if (!response.ok) throw new Error('Falha na resposta da rede');
      
      const json = await response.json();
      
      if (json.status === 'success') {
        setRawData(json.data);
        processData(json.data.pacientes, json.data.atendimentos);
      } else {
        throw new Error('Formato de dados inválido da API.');
      }
    } catch (err) {
      console.error(err);
      setError("Não foi possível conectar à planilha. Certifique-se de que o Apps Script está publicado como 'Qualquer pessoa'. Se estiver no Canvas, erros de CORS são esperados.");
    } finally {
      setLoading(false);
    }
  };

  const processData = (pacientes, atendimentos) => {
    const joined = atendimentos.map(att => {
      // Normalização de chaves para evitar erros de case-sensitive
      const pacCPF = String(att.CPF_PACIENTE || '').trim();
      const pac = pacientes.find(p => String(p.CPF || '').trim() === pacCPF) || {};
      
      return { 
        ...att, 
        ...pac, 
        id: att.ID_ATENDIMENTO || Math.random(), 
        dataAbertura: att.DATA_ABERTURA,
        indicacao: att['INDICAÇÃO'],
        status: att.STATUS,
        procedimento: att.PROCEDIMENTO,
        especialidade: att.ESPECIALIDADE,
        dataMarcacao: att.DATA_MARCACAO,
        local: att.LOCAL 
      };
    });
    setJoinedData(joined);
  };

  useEffect(() => {
    if (userMode) fetchData();
  }, [userMode]);

  // --- LOGIN ---
  const handleLogin = (e) => {
    e.preventDefault();
    if (loginPass === 'gabinete123') {
      setUserMode('admin');
    } else {
      setLoginError('Senha incorreta');
    }
  };

  // --- SAVE ---
  const handleSave = async () => {
    setSaving(true);
    let action = '';
    let payload = { ...formData };

    if (modalType === 'NEW_PATIENT') action = 'CREATE_PACIENTE';
    if (modalType === 'NEW_ATTENDANCE') {
      action = 'CREATE_ATENDIMENTO';
      payload.cpfPaciente = selectedPatient?.CPF;
      payload.nomePaciente = selectedPatient?.NOME;
    }
    
    try {
      // mode: 'no-cors' é necessário para Apps Script web app POST
      await fetch(API_URL, {
        method: 'POST',
        mode: 'no-cors', 
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, payload })
      });
      
      setTimeout(() => {
        setSaving(false);
        setIsModalOpen(false);
        alert("Dados enviados! Aguarde alguns segundos e atualize para ver as mudanças.");
        fetchData(); 
      }, 2000);
      
    } catch (e) {
      alert("Erro ao salvar: " + e.message);
      setSaving(false);
    }
  };

  // --- FILTROS ---
  const availableYears = useMemo(() => {
    const years = new Set();
    joinedData.forEach(item => {
      const y = getYear(item.dataAbertura);
      if (y !== 'Desconhecido') years.add(y);
    });
    return Array.from(years).sort().reverse();
  }, [joinedData]);

  const availableMonths = useMemo(() => {
    const months = new Set();
    joinedData.forEach(item => {
      if (selectedYear === 'Geral' || getYear(item.dataAbertura) === selectedYear) {
        const name = getMonthName(item.dataAbertura);
        if (name !== 'Desconhecido') months.add(name);
      }
    });
    return Array.from(months).sort((a, b) => (monthOrder[a] || 99) - (monthOrder[b] || 99));
  }, [joinedData, selectedYear]);

  const filteredData = useMemo(() => {
    let data = joinedData;
    if (selectedYear !== 'Geral') {
      data = data.filter(item => getYear(item.dataAbertura) === selectedYear);
    }
    if (selectedMonth !== 'Geral') {
      data = data.filter(item => getMonthName(item.dataAbertura) === selectedMonth);
    }
    return data;
  }, [selectedMonth, selectedYear, joinedData]);

  // --- ESTATÍSTICAS ---
  const stats = useMemo(() => {
    const total = filteredData.length;
    const concluidos = filteredData.filter(d => String(d.status).toUpperCase().includes("CONCLUI")).length;
    const pendentes = filteredData.filter(d => String(d.status).toUpperCase().includes("PENDENTE") || String(d.status).toUpperCase().includes("ANÁLISE")).length;
    const cancelados = filteredData.filter(d => String(d.status).toUpperCase().includes("CANCELADO")).length;
    
    let totalValor = 0;
    filteredData.forEach(d => {
      if (String(d.status).toUpperCase().includes("CONCLUI")) totalValor += getProcedureValue(d.procedimento);
    });

    let totalDias = 0;
    let countComDatas = 0;
    filteredData.forEach(d => {
      const dtSolicitacao = parseDate(d.dataAbertura);
      const dtAtendimento = parseDate(d.dataMarcacao);
      if (dtSolicitacao && dtAtendimento) {
        const diffTime = Math.abs(dtAtendimento - dtSolicitacao);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        totalDias += diffDays;
        countComDatas++;
      }
    });
    const mediaDias = countComDatas > 0 ? (totalDias / countComDatas).toFixed(1) : 0;

    const agg = (field) => filteredData.reduce((acc, curr) => {
      const k = curr[field] || 'N/I';
      acc[k] = (acc[k] || 0) + 1;
      return acc;
    }, {});

    const chartEsp = Object.keys(agg('especialidade')).map(k => ({ name: k, value: agg('especialidade')[k] })).sort((a,b) => b.value - a.value);
    const chartBairro = Object.keys(agg('BAIRRO')).map(k => ({ name: k, value: agg('BAIRRO')[k] })).sort((a,b) => b.value - a.value);
    
    // Sexo
    const m = filteredData.filter(d => String(d.SEXO).toUpperCase().startsWith('M')).length;
    const f = filteredData.filter(d => String(d.SEXO).toUpperCase().startsWith('F')).length;
    const totalS = m + f || 1;

    return { total, concluidos, pendentes, cancelados, totalValor, pctM: Math.round(m/totalS*100), pctF: Math.round(f/totalS*100), chartEsp, chartBairro };
  }, [filteredData]);

  // --- ESTATÍSTICAS RELATÓRIOS ---
  const reportStats = useMemo(() => {
    const pendingItems = filteredData.filter(d => {
        const st = d.status ? String(d.status).toUpperCase().trim() : "";
        if (st.includes("CONCLUI") || st.includes("CONCLUÍ") || st.includes("REALIZADO") || st.includes("CANCELADO")) return false;
        const isPendente = st.includes("PENDENTE") || st.includes("ANÁLISE") || st.includes("ANALISE");
        return isPendente || !d.dataMarcacao;
    });

    const hoje = new Date(); 
    const faixas = { "0-15 dias": 0, "16-30 dias": 0, "+30 dias": 0 };
    const tempoPorEsp = {};
    
    pendingItems.forEach(item => {
      const dtSolicitacao = parseDate(item.dataAbertura);
      if (!dtSolicitacao) return;
      const diffTime = Math.abs(hoje - dtSolicitacao);
      const diasEspera = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diasEspera <= 15) faixas["0-15 dias"]++;
      else if (diasEspera <= 30) faixas["16-30 dias"]++;
      else faixas["+30 dias"]++;
      
      const esp = item.especialidade || "Geral";
      if (!tempoPorEsp[esp]) tempoPorEsp[esp] = { totalDias: 0, count: 0 };
      tempoPorEsp[esp].totalDias += diasEspera;
      tempoPorEsp[esp].count += 1;
    });
    const chartDataFaixas = Object.keys(faixas).map(k => ({ name: k, value: faixas[k] }));
    const chartDataTempoEsp = Object.keys(tempoPorEsp).map(k => ({
      name: k,
      dias: Math.round(tempoPorEsp[k].totalDias / tempoPorEsp[k].count),
      qtd: tempoPorEsp[k].count
    })).sort((a, b) => b.dias - a.dias);
    
    return { 
      totalPendentes: pendingItems.length, 
      chartDataFaixas, 
      chartDataTempoEsp, 
      pendingItems: pendingItems.sort((a, b) => (parseDate(a.dataAbertura) || 0) - (parseDate(b.dataAbertura) || 0)) 
    };
  }, [filteredData]);

  // --- PARCEIROS ---
  const partnerStats = useMemo(() => {
    const stats = {};
    filteredData.forEach(item => {
      const p = item.indicacao || "Não informado";
      if (!stats[p]) stats[p] = { total: 0, concluidos: 0, pendentes: 0 };
      stats[p].total += 1;
      const isConcluido = String(item.status).toUpperCase().includes("CONCLUI");
      if (isConcluido) stats[p].concluidos += 1;
      else stats[p].pendentes += 1;
    });
    const chartDataRanking = Object.keys(stats).map(key => ({
      name: key,
      value: stats[key].total,
      concluidos: stats[key].concluidos,
      taxaSucesso: Math.round((stats[key].concluidos / stats[key].total) * 100)
    })).sort((a, b) => b.value - a.value);
    
    const topParceiro = chartDataRanking.length > 0 ? chartDataRanking[0] : { name: "-", value: 0 };
    return { chartDataRanking, topParceiro };
  }, [filteredData]);

  // --- ANIVERSARIANTES ---
  const birthdaysToday = useMemo(() => {
    const today = new Date();
    return rawData.pacientes.filter(item => {
      const birthDate = parseDate(item.DATA_NASCIMENTO);
      if (!birthDate) return false;
      return birthDate.getDate() === today.getDate() && birthDate.getMonth() === today.getMonth();
    });
  }, [rawData]);

  const toggleSidebar = () => setIsSidebarOpen(!isSidebarOpen);
  const handlePrint = () => window.print();

  if (!userMode) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
          <div className="text-center mb-8">
            <h1 className="text-3xl font-bold text-slate-800">Gabinete Digital</h1>
            <p className="text-slate-500">Vereador Paulinho Tudo a Ver</p>
          </div>
          <div className="space-y-4">
            <button onClick={() => setUserMode('visitor')} className="w-full flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 py-3 rounded-xl font-medium">
              <Users size={20}/> Entrar como Visitante
            </button>
            <div className="relative my-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-slate-500">Área Administrativa</span></div></div>
            <form onSubmit={handleLogin} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">Senha de Acesso</label>
                <div className="relative"><Lock className="absolute left-3 top-3 text-slate-400" size={18} /><input type="password" value={loginPass} onChange={e => setLoginPass(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Digite a senha..." /></div>
                {loginError && <p className="text-red-500 text-sm mt-1">{loginError}</p>}
              </div>
              <button type="submit" className="w-full flex items-center justify-center gap-2 bg-sky-600 hover:bg-sky-700 text-white py-3 rounded-xl font-bold"><LogIn size={20}/> Acessar Sistema</button>
            </form>
          </div>
        </div>
      </div>
    );
  }

  if (loading) return <div className="h-screen flex items-center justify-center bg-slate-50 gap-3"><Loader2 className="animate-spin text-sky-600"/> <span className="text-slate-600">Sincronizando com Google Sheets...</span></div>;
  
  if (error) {
    return (
      <div className="h-screen flex flex-col items-center justify-center text-center p-8 bg-slate-50">
        <div className="bg-white p-8 rounded-xl shadow-lg border border-red-100 max-w-lg">
          <div className="mx-auto w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4 text-red-500"><AlertTriangle size={24}/></div>
          <h2 className="text-xl font-bold text-slate-800 mb-2">Conexão Bloqueada (CORS)</h2>
          <p className="text-slate-600 mb-4 text-sm">{error}</p>
          <p className="text-xs text-slate-400 bg-slate-100 p-3 rounded text-left">
            <strong>Dica Técnica:</strong> Este erro é normal ao visualizar em ambientes de teste como este Canvas. 
            O navegador bloqueia requisições para <code>script.google.com</code> por segurança. 
            <br/><br/>
            <strong>Solução:</strong> Copie este código e publique no GitHub Pages ou Vercel. Lá funcionará perfeitamente.
          </p>
          <button onClick={() => window.location.reload()} className="mt-6 bg-sky-600 text-white px-6 py-2 rounded-lg hover:bg-sky-700">Tentar Novamente</button>
        </div>
      </div>
    );
  }

  return (
    <div className="flex h-screen bg-slate-50 font-sans text-slate-800 overflow-hidden">
      <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-white transform transition-transform duration-300 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 flex flex-col`}>
        <div className="p-6 border-b border-slate-700"><h1 className="text-xl font-bold text-sky-400">Gabinete</h1><p className="text-xs text-slate-400">Paulinho Tudo a Ver</p></div>
        <nav className="mt-6 px-4 space-y-2 flex-1">
          <NavItem icon={<PieChart/>} label="Dashboard" active={activeTab === 'Dashboard'} onClick={() => setActiveTab('Dashboard')} />
          <NavItem icon={<Users/>} label="Pacientes" active={activeTab === 'Pacientes'} onClick={() => {setActiveTab('Pacientes'); setSelectedPatient(null);}} />
          <NavItem icon={<Activity/>} label="Relatórios" active={activeTab === 'Relatorios'} onClick={() => setActiveTab('Relatorios')} />
          <NavItem icon={<Handshake/>} label="Parceiros" active={activeTab === 'Parceiros'} onClick={() => setActiveTab('Parceiros')} />
          <NavItem icon={<Cake/>} label="Aniversariantes" active={activeTab === 'Aniversariantes'} onClick={() => setActiveTab('Aniversariantes')} badge={birthdaysToday.length > 0 ? birthdaysToday.length : null} />
        </nav>
        <div className="p-6 bg-slate-800 text-xs text-slate-400"><p>Modo: <span className="font-bold text-white uppercase">{userMode}</span></p><button onClick={() => setUserMode(null)} className="mt-2 text-red-400 hover:text-red-300 flex items-center gap-1"><XCircle size={12}/> Sair</button></div>
      </aside>

      <main className="flex-1 flex flex-col overflow-hidden">
        <header className="bg-white shadow-sm p-4 flex justify-between items-center md:hidden z-10"><div className="font-bold text-slate-700">Painel de Atendimentos</div><button onClick={toggleSidebar} className="text-slate-600"><Menu size={24} /></button></header>
        <div className="bg-white border-b border-slate-200 px-8 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
          <div><h2 className="text-xl font-bold">{activeTab}</h2><p className="text-sm text-slate-500">Gestão Integrada</p></div>
          <div className="flex gap-3">
            {activeTab === 'Dashboard' && (
              <>
                <select value={selectedYear} onChange={e => setSelectedYear(e.target.value)} className="bg-slate-100 rounded-lg p-2 text-sm"><option value="Geral">Ano: Todos</option>{availableYears.map(y => <option key={y} value={y}>{y}</option>)}</select>
                <select value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="bg-slate-100 rounded-lg p-2 text-sm"><option value="Geral">Mês: Todos</option>{availableMonths.map(m => <option key={m} value={m}>{m}</option>)}</select>
              </>
            )}
            {activeTab === 'Pacientes' && !selectedPatient && userMode === 'admin' && (
              <button onClick={() => { setModalType('NEW_PATIENT'); setFormData({}); setIsModalOpen(true); }} className="bg-sky-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-sky-700"><Plus size={18}/> Novo Paciente</button>
            )}
          </div>
        </div>

        <div className="flex-1 overflow-auto p-8">
          {activeTab === 'Dashboard' && (
            <div className="animate-in fade-in duration-500 space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                <div className="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-xl p-6 text-white shadow-lg relative overflow-hidden">
                  <div className="relative z-10"><p className="flex items-center gap-2 mb-1 opacity-90"><DollarSign size={18}/> Economia Estimada</p><h3 className="text-4xl font-bold">R$ {stats.totalValor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h3></div>
                  <DollarSign className="absolute right-0 bottom-0 opacity-10" size={140} />
                </div>
                <div className="grid grid-cols-2 gap-4">
                   <KpiCard title="Total" value={stats.total} icon={<FileText className="text-blue-500"/>} />
                   <KpiCard title="Concluídos" value={stats.concluidos} icon={<CheckCircle className="text-green-500"/>} borderColor="border-l-4 border-green-500" />
                   <KpiCard title="Pendentes" value={stats.pendentes} icon={<AlertCircle className="text-yellow-500"/>} borderColor="border-l-4 border-yellow-500" />
                   <KpiCard title="Cancelados" value={stats.cancelados} icon={<XCircle className="text-red-500"/>} borderColor="border-l-4 border-red-500" />
                </div>
                <KpiCard title="Tempo Médio" value={`${stats.mediaDias} dias`} icon={<Clock className="text-indigo-500"/>} borderColor="border-l-4 border-indigo-500" />
              </div>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <ChartContainer title="Especialidades">
                  <ResponsiveContainer width="100%" height={300}>
                    <BarChart data={stats.chartEsp} layout="vertical" margin={{left: 40}}><XAxis type="number" hide /><YAxis dataKey="name" type="category" width={100} tick={{fontSize: 11}} /><Tooltip /><Bar dataKey="value" fill={COLORS.primary} radius={[0, 4, 4, 0]} barSize={20} /></BarChart>
                  </ResponsiveContainer>
                </ChartContainer>
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                  <h3 className="font-bold text-slate-700 mb-4">Demografia</h3>
                  <div className="flex justify-center gap-12 items-end h-[220px]">
                    <GenderBody type="male" percentage={stats.pctM} />
                    <GenderBody type="female" percentage={stats.pctF} />
                  </div>
                </div>
              </div>
            </div>
          )}

          {activeTab === 'Pacientes' && (
            <div className="animate-in fade-in duration-500">
              {!selectedPatient ? (
                <>
                  {/* COUNTERS */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div className="bg-white p-4 rounded-xl border border-slate-200 flex items-center gap-4 shadow-sm">
                      <div className="p-3 bg-sky-100 text-sky-600 rounded-full"><Users size={24}/></div>
                      <div><p className="text-sm text-slate-500">Pacientes Cadastrados</p><h3 className="text-2xl font-bold">{uniquePatients.length}</h3></div>
                    </div>
                    <div className="bg-white p-4 rounded-xl border border-slate-200 flex items-center gap-4 shadow-sm">
                      <div className="p-3 bg-indigo-100 text-indigo-600 rounded-full"><FileText size={24}/></div>
                      <div><p className="text-sm text-slate-500">Total de Atendimentos</p><h3 className="text-2xl font-bold">{uniquePatients.reduce((acc, p) => acc + p.historico.length, 0)}</h3></div>
                    </div>
                  </div>

                  <div className="mb-6 relative">
                    <Search className="absolute left-3 top-3.5 text-slate-400" size={20} />
                    <input type="text" placeholder="Buscar por Nome, CPF ou Prontuário..." className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-sky-500" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                  </div>
                  <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table className="w-full text-sm text-left">
                      <thead className="bg-slate-50 text-xs uppercase text-slate-500">
                        <tr>
                          <th className="p-4 w-12 text-center">#</th>
                          <th className="p-4">Nome</th>
                          <th className="p-4">CPF</th>
                          <th className="p-4">Bairro</th>
                          <th className="p-4">Telefone</th>
                          <th className="p-4">Ação</th>
                        </tr>
                      </thead>
                      <tbody>
                        {rawData.pacientes
                          .filter(p => (p.NOME && p.NOME.toLowerCase().includes(searchTerm.toLowerCase())) || (p.CPF && String(p.CPF).includes(searchTerm)))
                          .map((p, index) => (
                          <tr key={p.ID_PACIENTE || Math.random()} className="border-b hover:bg-slate-50">
                            <td className="p-4 text-center text-slate-400 font-mono">{index + 1}</td>
                            <td className="p-4 font-medium">{p.NOME}</td>
                            <td className="p-4">{p.CPF}</td>
                            <td className="p-4">{p.BAIRRO}</td>
                            <td className="p-4">{p.TELEFONE_1}</td>
                            <td className="p-4"><button onClick={() => setSelectedPatient(p)} className="text-sky-600 font-bold hover:underline">Ficha</button></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </>
              ) : (
                <PatientDetail 
                  patient={selectedPatient} 
                  attendances={joinedData.filter(a => String(a.CPF_PACIENTE).trim() === String(selectedPatient.CPF).trim())}
                  onBack={() => setSelectedPatient(null)}
                  onAddAttendance={() => { setModalType('NEW_ATTENDANCE'); setFormData({}); setIsModalOpen(true); }}
                  userMode={userMode}
                />
              )}
            </div>
          )}

          {activeTab === 'Relatorios' && (
            <div className="animate-in fade-in duration-500">
               <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                  <div className="bg-red-50 border border-red-200 p-6 rounded-xl flex items-center gap-4"><div className="p-3 bg-red-100 text-red-600 rounded-full"><AlertTriangle size={24} /></div><div><p className="text-sm text-red-600 font-medium">Total de Pendências</p><h3 className="text-2xl font-bold text-red-800">{reportStats.totalPendentes}</h3></div></div>
                  <div className="bg-orange-50 border border-orange-200 p-6 rounded-xl flex items-center gap-4"><div className="p-3 bg-orange-100 text-orange-600 rounded-full"><Clock size={24} /></div><div><p className="text-sm text-orange-600 font-medium">Críticos (+30 dias)</p><h3 className="text-2xl font-bold text-orange-800">{reportStats.chartDataFaixas.find(f => f.name === '+30 dias')?.value || 0}</h3></div></div>
               </div>
               <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                  <div className="px-6 py-4 border-b border-slate-100 bg-slate-50"><h3 className="font-semibold text-slate-800">Fila de Espera Detalhada</h3></div>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left">
                      <thead className="text-xs text-slate-500 uppercase bg-slate-50">
                        <tr>
                          <th className="p-3 w-12 text-center">#</th>
                          <th className="p-3">Paciente</th>
                          <th className="p-3">Especialidade</th>
                          <th className="p-3">Data Abertura</th>
                          <th className="p-3">Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {reportStats.pendingItems.map((item, index) => (
                          <tr key={item.id} className="border-b hover:bg-slate-50">
                            <td className="p-3 text-center text-slate-400 font-mono">{index + 1}</td>
                            <td className="p-3 font-medium">{item.NOME}</td>
                            <td className="p-3">{item.especialidade}</td>
                            <td className="p-3 font-bold text-red-600">{formatDate(item.dataAbertura)}</td>
                            <td className="p-3"><StatusBadge status={item.status} /></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
               </div>
            </div>
          )}

          {activeTab === 'Parceiros' && (
            <div className="animate-in fade-in duration-500">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div className="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-xl p-6 text-white relative overflow-hidden shadow-lg">
                  <div className="relative z-10"><p className="text-purple-100 text-sm font-medium mb-1 flex items-center gap-2"><Trophy size={16} /> Campeão de Indicações</p><h3 className="text-2xl font-bold truncate">{partnerStats.topParceiro.name}</h3><p className="text-3xl font-extrabold mt-2">{partnerStats.topParceiro.value} <span className="text-lg font-normal opacity-80">solicitações</span></p></div>
                  <Trophy className="absolute right-0 bottom-0 opacity-10 transform translate-x-4 translate-y-4" size={120} />
                </div>
              </div>
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div className="lg:col-span-2">
                  <ChartContainer title="Ranking por Indicação">
                    <ResponsiveContainer width="100%" height={350}><BarChart data={partnerStats.chartDataRanking} layout="vertical" margin={{top: 5, right: 30, left: 40, bottom: 5}}><CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} /><XAxis type="number" /><YAxis dataKey="name" type="category" width={140} tick={{fontSize: 12}} /><Tooltip /><Bar dataKey="value" fill={COLORS.purple} radius={[0, 4, 4, 0]} barSize={25} /></BarChart></ResponsiveContainer>
                  </ChartContainer>
                </div>
              </div>
            </div>
          )}

          {activeTab === 'Aniversariantes' && (
            <div className="animate-in fade-in duration-500">
               <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
                  <div className="flex items-center gap-4"><div className="p-4 bg-pink-100 text-pink-600 rounded-full"><Cake size={32} /></div><div><h2 className="text-xl font-bold text-slate-800">Hoje é dia de festa!</h2><p className="text-slate-500">{birthdaysToday.length} paciente(s) fazem aniversário hoje.</p></div></div>
               </div>
               <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {birthdaysToday.map(person => (
                    <div key={person.ID_PACIENTE} className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow">
                        <h3 className="font-bold text-lg text-slate-800">{person.NOME}</h3>
                        <p className="text-sm text-slate-500">{person.BAIRRO}</p>
                        <p className="text-xs text-slate-400 mb-4">{person.TELEFONE_1}</p>
                        <button className="w-full bg-green-500 text-white py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2"><MessageCircle size={16}/> Parabenizar no Zap</button>
                    </div>
                  ))}
               </div>
            </div>
          )}
        </div>
      </main>

      {isModalOpen && (
        <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
          <div className="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
            <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold">{modalType === 'NEW_PATIENT' ? 'Novo Paciente' : 'Novo Atendimento'}</h3><button onClick={() => setIsModalOpen(false)}><X/></button></div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {modalType === 'NEW_PATIENT' && (
                <>
                  <Input label="Nome Completo" onChange={v => setFormData({...formData, nome: v})} />
                  <Input label="CPF" onChange={v => setFormData({...formData, cpf: v})} />
                  <Input label="Telefone" onChange={v => setFormData({...formData, tel1: v})} />
                  <Input label="Bairro" onChange={v => setFormData({...formData, bairro: v})} />
                </>
              )}
              {modalType === 'NEW_ATTENDANCE' && (
                <>
                  <div className="col-span-2 bg-slate-50 p-3 rounded mb-2 border border-slate-200"><p className="text-sm font-bold text-slate-700">Paciente: {selectedPatient.NOME}</p></div>
                  <Input label="Data Abertura" type="date" onChange={v => setFormData({...formData, dataAbertura: v})} />
                  <Input label="Especialidade" onChange={v => setFormData({...formData, especialidade: v})} />
                  <Input label="Procedimento" onChange={v => setFormData({...formData, procedimento: v})} />
                  <Input label="Local" onChange={v => setFormData({...formData, local: v})} />
                </>
              )}
            </div>
            <div className="mt-8 flex justify-end gap-3"><button onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">Cancelar</button><button onClick={handleSave} disabled={saving} className="px-6 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 flex items-center gap-2 disabled:opacity-50">{saving ? <Loader2 className="animate-spin" size={18}/> : <Save size={18}/>} Salvar</button></div>
          </div>
        </div>
      )}
    </div>
  );
}

// --- SUB COMPONENTS ---
function Input({ label, type = "text", placeholder, className, onChange }) {
  return (
    <label className={`block ${className}`}>
      <span className="text-xs font-bold text-slate-500 uppercase">{label}</span>
      <input type={type} placeholder={placeholder} onChange={e => onChange(e.target.value)} className="w-full mt-1 px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-sky-500 outline-none" />
    </label>
  );
}

function PatientDetail({ patient, attendances, onBack, onAddAttendance, userMode }) {
  const handlePrint = () => window.print();
  return (
    <div className="max-w-5xl mx-auto">
      <div className="flex justify-between items-center mb-6 print:hidden">
        <button onClick={onBack} className="flex items-center gap-2 text-slate-500 hover:text-slate-800"><ArrowLeft size={20}/> Voltar</button>
        <div className="flex gap-2">
          {userMode === 'admin' && <button onClick={onAddAttendance} className="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-emerald-700"><Plus size={18}/> Novo Atendimento</button>}
          <button onClick={handlePrint} className="bg-slate-800 text-white px-4 py-2 rounded-lg flex gap-2 hover:bg-slate-700"><Printer size={18}/> Imprimir</button>
        </div>
      </div>
      <div className="bg-white p-8 rounded-xl shadow-lg border border-slate-200 print:shadow-none print:border-none">
        <div className="border-b-2 border-slate-100 pb-4 mb-6 flex justify-between">
          <div><h2 className="text-3xl font-bold text-slate-800">{patient.NOME}</h2>{patient.APELIDO && <p className="text-lg text-slate-500 italic">"{patient.APELIDO}"</p>}</div>
          <div className="text-right"><p className="text-xs text-slate-400 uppercase font-bold">Prontuário</p><p className="text-xl font-mono text-slate-700">{patient.PRONTUÁRIO || '---'}</p></div>
        </div>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8 bg-slate-50 p-4 rounded-xl print:bg-transparent print:p-0">
           <div><label className="text-xs text-slate-400 font-bold block">CPF</label>{patient.CPF}</div>
           <div><label className="text-xs text-slate-400 font-bold block">SUS</label>{patient.SUS}</div>
           <div><label className="text-xs text-slate-400 font-bold block">Nascimento</label>{formatDate(patient.DATA_NASCIMENTO)}</div>
           <div><label className="text-xs text-slate-400 font-bold block">Telefone</label>{patient.TELEFONE_1}</div>
           <div className="col-span-2"><label className="text-xs text-slate-400 font-bold block">Endereço</label>{patient.LOGRADOURO}, {patient.BAIRRO}</div>
           <div><label className="text-xs text-slate-400 font-bold block">Indicação</label>{patient.FAMILIA || patient.INDICAÇÃO || patient.INDICACAO}</div>
           <div className="col-span-4 mt-2 pt-2 border-t border-slate-200"><label className="text-xs text-slate-400 font-bold block mb-1">Observações do Cadastro</label><p className="text-sm text-slate-700 italic">{patient.OBSERVACOES_FIXAS || "Nenhuma observação registrada."}</p></div>
        </div>
        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><History size={20}/> Histórico de Atendimentos</h3>
        {attendances.map(att => {
          const risk = checkSurgicalRisk(att.DATA_RISCO, att.LOCAL);
          return (
            <div key={att.id} className="border border-slate-200 rounded-lg p-4 mb-3 hover:bg-slate-50 transition-colors break-inside-avoid">
              <div className="flex justify-between items-start mb-2">
                <div>
                  <div className="flex items-center gap-2"><span className="font-bold text-sky-700">{att.PROCEDIMENTO}</span><span className="text-xs bg-slate-200 px-2 py-0.5 rounded text-slate-600">{att.ESPECIALIDADE}</span></div>
                  <p className="text-xs text-slate-500 mt-1">Abertura: {formatDate(att.DATA_ABERTURA)} | Local: {att.LOCAL} ({att.PARCEIRO})</p>
                </div>
                <div className="text-right"><StatusBadge status={att.STATUS} /></div>
              </div>
              {att.OBS_ATENDIMENTO && <div className="bg-yellow-50 text-yellow-800 text-sm p-2 rounded border border-yellow-100 mb-2">Obs: {att.OBS_ATENDIMENTO}</div>}
              {risk.status !== 'none' && <div className={`text-xs p-2 rounded border flex justify-between items-center ${risk.color}`}><span className="flex items-center gap-1 font-bold"><HeartPulse size={12}/> Risco Cirúrgico</span><span>{risk.msg}</span></div>}
            </div>
          );
        })}
      </div>
    </div>
  );
}

function GenderBody({ type, percentage }) {
  const fillColor = type === 'male' ? "#3b82f6" : "#ec4899"; 
  const path = type === 'male' ? "M12 2C10.3 2 9 3.3 9 5C9 6.7 10.3 8 12 8C13.7 8 15 6.7 15 5C15 3.3 13.7 2 12 2ZM6 9C4.9 9 4 9.9 4 11V16C4 16.6 4.4 17 5 17H6V22C6 23.1 6.9 24 8 24H9C10.1 24 11 23.1 11 22V19H13V22C13 23.1 13.9 24 15 24H16C17.1 24 18 23.1 18 22V17H19C19.6 17 20 16.6 20 16V11C20 9.9 19.1 9 18 9H6Z" : "M12 2C10.3 2 9 3.3 9 5C9 6.7 10.3 8 12 8C13.7 8 15 6.7 15 5C15 3.3 13.7 2 12 2ZM6 9C4.9 9 4 9.9 4 11V14L6 22C6 23.1 6.9 24 8 24H9C10.1 24 11 23.1 11 22V19H13V22C13 23.1 13.9 24 15 24H16C17.1 24 18 23.1 18 22L20 14V11C20 9.9 19.1 9 18 9H6Z";
  return (
    <div className="flex flex-col items-center">
      <svg width="60" height="120" viewBox="0 0 24 26" className="drop-shadow-sm"><defs><linearGradient id={`fill-${type}`} x1="0" x2="0" y1="1" y2="0"><stop offset={`${percentage}%`} stopColor={fillColor} /><stop offset={`${percentage}%`} stopColor="#e2e8f0" /></linearGradient></defs><path d={path} fill={`url(#fill-${type})`} /></svg>
      <div className="mt-2 text-center"><span className={`text-lg font-bold ${type === 'male' ? 'text-blue-500' : 'text-pink-500'}`}>{percentage}%</span></div>
    </div>
  );
}

function NavItem({ icon, label, active, onClick, badge }) {
  return <button onClick={onClick} className={`w-full flex items-center justify-between px-4 py-3 rounded-lg transition-colors ${active ? 'bg-sky-600 text-white shadow-lg shadow-sky-900/20' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}><div className="flex items-center gap-3">{icon}<span className="font-medium text-sm">{label}</span></div>{badge && <span className="bg-pink-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">{badge}</span>}</button>;
}

function KpiCard({ title, value, icon, subtext, borderColor = "border-l-4 border-blue-500" }) {
  return <div className={`bg-white rounded-xl shadow-sm p-6 ${borderColor} relative overflow-hidden`}><div className="flex justify-between items-start mb-2"><div><p className="text-sm font-medium text-slate-500 mb-1">{title}</p><h3 className="text-2xl font-bold text-slate-800">{value}</h3></div><div className="p-2 bg-slate-50 rounded-lg">{icon}</div></div><div className="flex items-center text-xs"><span className="text-slate-400">{subtext}</span></div></div>;
}

function ChartContainer({ title, children }) { return <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 className="text-base font-semibold text-slate-700 mb-6">{title}</h3>{children}</div>; }

function StatusBadge({ status }) {
  let styles = "bg-gray-100 text-gray-800";
  const st = String(status).toUpperCase();
  if (st.includes("CONCLUI") || st.includes("CONCLUÍ")) styles = "bg-green-100 text-green-800";
  else if (st.includes("PENDENTE")) styles = "bg-red-100 text-red-800";
  else if (st.includes("CANCELADO")) styles = "bg-red-100 text-red-800 line-through";
  else if (st.includes("ANÁLISE") || st.includes("ANALISE")) styles = "bg-yellow-100 text-yellow-800";
  return <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${styles}`}>{status || '-'}</span>;
}
